# 抖音媒体提取器 - 技术原理

本文档详细介绍了 `douyin_extractor.py` 的内部工作原理。

## 技术架构

```
┌─────────────────────────────────────────────────────────────┐
│                    用户输入: 抖音视频页面 URL                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  Playwright 启动 Chromium 浏览器              │
│                    (模拟真实用户访问)                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    注册网络响应监听器                          │
│              page.on("response", handle_response)            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      导航到目标视频页面                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│       拦截 API 响应: aweme/v1/web/aweme/detail               │
│              (包含视频详情的 JSON 数据)                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                 解析 bit_rate 数组                            │
│           (包含所有清晰度的视频流信息)                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              选择最高画质的 mp4 格式视频链接                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       输出视频直链                            │
└─────────────────────────────────────────────────────────────┘
```

## 核心原理

### 1. 为什么使用浏览器自动化？

抖音网页端有多层反爬虫保护：

| 保护机制 | 说明 |
|---------|------|
| **动态签名** | 每个 API 请求需要 `__ac_signature`、`X-Bogus` 等动态生成的签名参数 |
| **JavaScript 混淆** | 签名算法被混淆在 `_$jsvmprt` 等 JS 虚拟机中 |
| **客户端验证** | 首次访问会加载验证脚本，检测是否为真实浏览器 |
| **Cookie 依赖** | 需要有效的会话 Cookie 才能获取完整数据 |

**解决方案**：使用 Playwright 控制真实浏览器，让浏览器自动处理所有 JavaScript 执行和签名生成。

### 2. 网络请求拦截机制 (Video)

```python
def handle_response(response):
    # 监听所有网络响应
    if "aweme/v1/web/aweme/detail" in response.url and response.status == 200:
        # 这是视频详情 API，包含所有清晰度信息
        json_data = response.json()
        # 解析视频数据...

# 注册监听器
page.on("response", handle_response)
```

当浏览器加载抖音视频页面时，页面会自动发起 API 请求获取视频详情。我们拦截这个响应，就能获取到所有视频信息。

### 3. 清晰度选择算法

API 返回的 `bit_rate` 数组包含所有可用清晰度。

**选择策略**：
1. **只选 `mp4` 格式** - `dash` 格式是视频/音频分离流，方便直接播放/下载
2. **优先最高分辨率** - 4K > 2K > 1080p > 720p
3. **同分辨率选最高码率** - 码率越高，画质越好

### 4. 图文/动图提取原理 (Note)

图集/动图页面 (`/note/`) 的数据提取采用了混合策略：

1. **API 提取 (优先)**: 尝试调用 `aweme/v1/web/aweme/detail` API。这是获取动图（虽然不仅是 WebP 格式，但本质上是视频）和原始高清图片的最佳方式。
2. **DOM 解析 (降级)**: 如果 API 调用失败，脚本会回退到解析页面 DOM，从 `background-image` 样式或 `<img>` 标签中提取图片链接。

对于动图内容，抖音实际上同时提供了 **WebP 动图** 和 **MP4 视频** 两种格式。我们的 API 会同时返回这两种链接，供调用方选择。

## 总结

| 步骤 | 技术实现 |
|------|---------|
| 绕过反爬虫 | Playwright 模拟真实浏览器 |
| 视频提取 | 拦截 `aweme/v1/web/aweme/detail` API |
| 图片提取 | API 拦截 + DOM 解析作为 fallback |
| 选择最佳画质 | 筛选 mp4 格式 + 最高分辨率 + 最高码率 |
